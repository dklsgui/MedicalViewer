<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nifti Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/layui/2.9.14/css/layui.css" integrity="sha512-YL3el60sSycKIM/ld2Vf1bD4qd3JvBJ0+y4Ra/rOdZrin7FC+ng3JSu2yGHddZ6m+npECxE4BCw76sGnH9PyWw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="${cssUri}">
</head>

<body>        
    <div id="main">
        <div class="padding"></div>
        <div id="info">
            <table>
                <thead>
                    <tr>
                        <th>Dimensions</th>
                        <th>Spacing</th>
                        <th>DataType</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="dimensions">Loding</td>
                        <td id="spacing">Loding</td>
                        <td id="datatype">Loding</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="padding"></div>
        <div id="label_workspace">
            <div id="label_list">
                <!-- <div class="label">
                    <span>1dwhqodqh</span>
                    <i class="layui-icon layui-icon-close delete-label"></i>
                </div>            -->
            </div>
            <div id="add_label">
                <i id="add_label_icon" class="layui-icon layui-icon-addition" title="add label"></i>
            </div>
        </div>
        <div class="padding"></div>
        <div id="panel">
            <div id="axis">
                <div class="buttons">
                    <button class="layui-btn layui-btn-fluid" id="X" is_selected="false">X</button>
                    <button class="layui-btn layui-btn-fluid" id="Y" is_selected="false">Y</button>
                    <button class="layui-btn layui-btn-fluid" id="Z" is_selected="true">Z</button>
                </div>
                <div class="slider">
                    <i class="layui-inline" id="slice"></i>
                </div>
            </div>
            <div id="data">
                <canvas id="canvas"></canvas>
            </div>
            <div id="window">
                <div class="buttons">
                    <input type="text" placeholder="W" class="layui-input" id="window_width" onchange="window_changed()">
                    <input type="text" placeholder="L" class="layui-input" id="window_level" onchange="window_changed()">
                    <button class="layui-btn layui-btn-fluid" id="C" style="visibility: hidden;">Z</button>
                </div>
                <div class="slider">
                    <i class="layui-inline" id="windows"></i>
                </div>
            </div>
        </div>
        <div class="padding"></div>
    </div>
    <script type="text/javascript" src="${scriptUri}"></script>
    <script>
        sliders = {
            slice: null,
            window: null
        }
        function render_slice_slider(min, max, height, value) {
            document.getElementById('slice').innerHTML = '';
            sliders.slice = layui.slider.render({
                elem: "#slice",
                min: min,
                max: max,
                value: value,
                height: height,
                type: 'vertical',
                change: function(value) {
                    sliders.slice.config.value = value;
                    window.postMessage({command: 'slice_change', value: value});
                }
            });
        }
        
        function render_window_slider(min, max, height, min_threshold, max_threshold) {
            document.getElementById('windows').innerHTML = '';
            sliders.window = layui.slider.render({
                elem: "#windows",
                min: min,
                max: max,
                range: true,
                height: height,
                type: 'vertical',
                value: [min_threshold, max_threshold],
                change: function(value) {
                    document.getElementById('window_width').value = value[1] - value[0];
                    document.getElementById('window_level').value = (value[1] + value[0]) / 2;
                    window.postMessage({command: 'window_change', min_threshold: value[0], max_threshold: value[1]});
                }
            });
            let window_width = document.getElementById('window_width');
            let window_level = document.getElementById('window_level');
            window_width.value = max_threshold - min_threshold;
            window_level.value = (max_threshold + min_threshold) / 2;
        }
        
        function window_changed() {
            let window_width = document.getElementById('window_width').value;
            let window_level = document.getElementById('window_level').value;
            if(window_width === '-' || window_level === '-') {
                return;
            }
            window_width = parseFloat(window_width);
            window_level = parseFloat(window_level);
            if(isNaN(window_width) || isNaN(window_level)) {
                return;
            }

            let min_threshold = window_level - window_width / 2;
            let max_threshold = window_level + window_width / 2;

            min_threshold = Math.max(min_threshold, sliders.window.config.min);
            max_threshold = Math.min(max_threshold, sliders.window.config.max);

            sliders.window.setValue(min_threshold, 0);
            sliders.window.setValue(max_threshold, 1);
        }
        
        window.addEventListener('message', function(event) {
            let data = event.data;
            if (data.command === 'render_slice_slider') {
                render_slice_slider(data.min, data.max, data.height, data.value);
            }else if (data.command === 'render_window_slider') {
                render_window_slider(data.min, data.max, data.height, data.min_threshold, data.max_threshold);
            } else if (data.command === 'render_colorpicker') {
                layui.use(function(){
                    var colorpicker = layui.colorpicker;
                    colorpicker.render({ // eg1
                        elem: data.elem, // 绑定元素
                        color: data.color,
                        format: 'rgb',
                        // @ts-ignore
                        change: function(color){ // 颜色改变的回调
                            window.postMessage({
                                command: 'color_change', 
                                color: color,
                                name: data.name
                            });
                        }
                    });
                });
            }
        });
        document.getElementById('canvas').addEventListener('wheel', function(event) {
            if (event.deltaY === 0) {
                return;
            }else if (event.deltaY > 0) {
                sliders.slice.setValue(sliders.slice.config.value - 1);
            }else {
                sliders.slice.setValue(sliders.slice.config.value + 1);
            }
        });
        window.postMessage({command: 'ready'});
    </script>
</body>
</html>